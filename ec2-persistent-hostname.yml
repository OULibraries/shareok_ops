---
  - name: Create cloud config temp file for safety
    command: cp -f /etc/cloud/cloud.cfg /etc/cloud/cloud.cfg.tmp
  - name: Create cloud config backup file for safety
    command: cp -f /etc/cloud/cloud.cfg /etc/cloud/cloud.cfg.bak
  - name: Make change in cloud config temp file
    lineinfile: "dest=/etc/cloud/cloud.cfg.tmp line='preserve_hostname: true'"
  - name: Replace orginal cloud config file
    shell: mv -f /etc/cloud/cloud.cfg.tmp /etc/cloud/cloud.cfg
  - name: Set hostname to instance name
    shell: hostnamectl set-hostname "{{ ec2_tag_Name }}"
  - name: Also set /etc/hosts for legacy change
    lineinfile: "dest=/etc/hosts line=""{{ ec2_private_ip }}" "{{ ec2_tag_Name }}"""
