---
  - name: Ensure scripts are executable.
    file: path=/vagrant/scripts state=directory mode=0775 recurse=yes
  - name: Ensure symlink to shareok-specific config script exists.
    file: src=/vagrant/etc/shareok.conf.sh dest=/vagrant/etc/conf.sh state=link force=yes
  - name: Ensure symlink to shareok-specific Catalina exists.
    file: src=/vagrant/etc/Catalina/shareok dest=/vagrant/etc/Catalina/localhost state=link force=yes
  - name: Ensure base packages are installed.
    yum: name={{ item }} state=latest
    with_items:
    - deltarpm
    - epel-release
    - nload
    - htop
    - sysstat
    - psmisc
    - iotop
    - yum-cron
    - policycoreutils-python
    - git
    - wget
    - curl
    - tree
    - emacs-nox
    - vim
    - ack
    - tmux
    - screen
  - name: Set Oklahoma time.
    command: timedatectl set-timezone America/Chicago
  - name: Ensure vagrant user has the .ssh directory
    sudo_user: vagrant
    file: path=/home/vagrant/.ssh state=directory mode=0700 owner=vagrant group=vagrant
  - name: Add github ssh fingerprints to vagrant ssh known_hosts.
    shell: >
      ssh-keyscan github.com | tee -a /home/vagrant/.ssh/known_hosts
  - name: Ensure PostgreSQL is installed.
    yum: name=postgresql-server state=installed
  - name: Run PostgreSQL initialization.
    command: postgresql-setup initdb
    register: postgres_setup_result
    ignore_errors: True
  - name: Fail the play if PostgreSQL exited with a code greater than 1 (Warning)
    fail: msg="Failed to initialize PostgreSQL."
    when: "postgres_setup_result.rc > 1"
  - name: Ensure PostgreSQL authentication config.
    copy:
      ## Note that the src is on the host machine.
      src: "etc/pg_hba.conf"
      dest: "/var/lib/pgsql/data/pg_hba.conf"
      owner: postgres
      group: postgres
  - name: Ensure PostgreSQL is running.
    service: name=postgresql state=started enabled=yes
  - name: Create shared PostgreSQL admin user.
    command: /vagrant/scripts/dspace-db-vagrant.sh
  - name: Create DSpace Database
    command: /vagrant/scripts/dspace-db.sh
  - name: setup netrc stuff for atmire checkout and kludge around bad atmire perms
    command: /vagrant/scripts/shareok-3x.sh
# Interaction with GitHub needs to be done as vagrant user because
# ssh agent forwarding works if we do it that way    
  - name: git checkout
    sudo_user: vagrant
    command: /vagrant/scripts/dspace-github.sh
#   - name: install mirage2 dspace theme
#     command: /vagrant/scripts/dspace-mirage2.sh
  - name: Ensure DSpace dependency packages are installed.
    yum: name={{ item }} state=latest
    with_items:
    - java-1.8.0-openjdk
    - maven
    - ant
    - tomcat
    - tomcat-webapps
    - tomcat-admin-webapps
  - name: Ensure Tomcat is started.
    service: name=tomcat state=started enabled=yes
  - name: Make the dspace web app location
    file: path="{{ dspace_run }}" state=directory mode=0755 owner=tomcat group=tomcat
  - name: Point tomcat at the dspace web app location
    command: 'cp -r /vagrant/etc/Catalina/localhost/ /usr/share/tomcat/conf/Catalina/localhost/'
  - name: Build the dspace install as the vagrant user
    sudo_user: vagrant
    command: /vagrant/bin/build.sh chdir="{{ dspace_src }}"
    register: dspace_build_result
    ignore_errors: True
  - name: Fail the play if build exits with a code greater than 1 (Warning)
    fail: msg="Failed to build DSpace."
    when: "dspace_build_result.rc > 1"
  - name: Ensure the webapp belongs to tomcat
    file: path="{{ dspace_run }}" state=directory mode=0755 owner=tomcat group=tomcat recurse=yes
  - name: Restart Tomcat.
    service: name=tomcat state=restarted enabled=yes
  - name: db cleanup
    command: /vagrant/scripts/shareok-3x-db.sh
